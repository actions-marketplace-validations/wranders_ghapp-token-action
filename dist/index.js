if(typeof __nccwpck_require__!=="undefined")__nccwpck_require__.ab=new URL(".",import.meta.url).pathname.slice(import.meta.url.match(/^file:\/\/\/\w:/)?1:0,-1)+"/";var t={};Object.defineProperty(exports,"__esModule",{value:true});const e=require("@actions/core");const n=require("crypto");const r=require("https");const o=require("util");function base64(t,e){const n=JSON.stringify(t);return urlBase64(Buffer.from(n,e).toString("base64"))}function urlBase64(t){return t.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function getJWT(t,e){const r={alg:"RS256",typ:"JWT"};const a=Math.floor(Date.now()/1e3);const s={iat:a-60,exp:a+600,iss:t};const i=(0,o.format)("%s.%s",base64(r,"binary"),base64(s,"utf-8"));const c=(0,n.createSign)("RSA-SHA256").update(i).sign(e,"base64");return(0,o.format)("%s.%s",i,urlBase64(c))}async function requestApi(t){return new Promise(((e,n)=>{let o="";const a=(0,r.request)(t,(t=>{t.setEncoding("utf-8");t.on("data",(t=>{o+=t}));t.on("end",(()=>{e(JSON.parse(o))}));t.on("error",(t=>{n(t)}))}));a.on("error",(t=>{n(t)}));a.on("timeout",(()=>{a.destroy()}));a.end()}))}async function getInstallation(t,e){const n={method:"GET",headers:{Accept:"application/vnd.github+json",Authorization:(0,o.format)("Bearer %s",t)},host:"api.github.com",path:"/app/installations"};const r=await requestApi(n);const a=r.find((t=>t.account.id===e));if(a===undefined)throw new Error("no installation found");return a.id}async function getToken(t,e){const n={method:"POST",headers:{Accept:"application/vnd.github+json",Authorization:(0,o.format)("Bearer %s",t)},host:"api.github.com",path:(0,o.format)("/app/installations/%s/access_tokens",e)};const r=await requestApi(n);return r.token}async function main(){try{const t=(0,e.getInput)("app_id",{required:true});const n=(0,e.getInput)("app_key_pem",{required:true});(0,e.setSecret)(n);const r=getJWT(t,n);const o=parseInt(process.env.GITHUB_REPOSITORY_OWNER_ID);const a=await getInstallation(r,o);const s=await getToken(r,a);(0,e.setSecret)(s);(0,e.setOutput)("token",s)}catch(t){if(t instanceof Error)(0,e.setFailed)(t.message)}}main();